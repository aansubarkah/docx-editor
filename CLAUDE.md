# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Docx Agent** is a web application that enables users to create and edit Microsoft Word `.docx` files via natural language instructions. The LLM acts as a planner, generating structured JSON operations that are executed server-side against `.docx` files using `python-docx`. The system provides HTML previews, stable paragraph IDs for precise anchors, versioning, and visual redline comparisons.

**Architecture:**
- **Backend**: FastAPI (Python) with `python-docx` for document manipulation
- **Frontend**: Vite + Vue 3 + TypeScript + Tailwind CSS
- **LLM Integration**: Optional OpenAI tool/function calling for operation planning (falls back to basic heuristics without API key)

## Development Commands

### Backend (FastAPI)
```bash
cd backend
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
export OPENAI_API_KEY=sk-...      # optional
export OPENAI_MODEL=gpt-4o-mini   # optional
uvicorn app:app --reload
```

### Frontend (Vite + Vue)
```bash
cd frontend
npm install
npm run dev        # Development server at http://localhost:5173
npm run build      # Production build to dist/
```

The backend serves the built frontend from `frontend/dist/` when running in production mode.

## Core Architecture

### Operation-Based Editing Model

All document modifications flow through a structured **Operation** schema enforced by Pydantic on the backend and TypeScript on the frontend. This prevents the LLM from directly manipulating files.

**Operation Types:**
- `add_heading`: Insert heading with specified level (1-6)
- `add_paragraph`: Insert body paragraph
- `replace_text`: Find and replace text in paragraphs
- `insert_table`: Create table with rows/cols and optional data

**Key Fields:**
- `after_paragraph_id`: Stable anchor ID for precise insertion (preferred)
- `after_heading_text`: Legacy fallback for insertion after heading text
- `find`/`replace`: For text replacement operations

### Stable Paragraph IDs

The system maintains **stable paragraph IDs** (`paragraph_id`) for reliable anchoring across edits:

- Generated by hashing: `normalized_text + heading_level + index`
- Format: `h{level}-{hash10}` for headings (e.g., `h2-abc1234567`) or `p-{hash10}` for body paragraphs
- Computed in `backend/utils.py:stable_paragraph_id()`
- Recomputed and persisted as JSON after every operation in `{file_id}.outline.json`
- Used by `after_paragraph_id` to insert content at precise locations

### Document Flow

1. **Create/Upload**: New docs created via `POST /api/create` or uploaded via `POST /api/upload`
2. **Plan Operations**: `POST /api/plan-ops` sends instruction + optional file_id â†’ LLM returns `operations[]`
3. **Apply Operations**: `POST /api/apply-ops` executes ops, saves new version, rebuilds outline
4. **Outline**: `GET /api/outline/{file_id}` returns current paragraph IDs with text/level
5. **Versioning**: Each apply creates snapshot `storage/versions/{file_id}/vN.docx`
6. **Redline Compare**: `GET /api/redline?base_id=...&revised_id=...` generates visual diff `.docx` with colored insertions (green underline) and deletions (red strikethrough)

### File Storage

- Active documents: `storage/{file_id}.docx`
- Outlines: `storage/{file_id}.outline.json`
- Versions: `storage/versions/{file_id}/v1.docx, v2.docx, ...`
- Storage directory configurable via `STORAGE_DIR` env var

### LLM Integration (Provider-Agnostic)

The app supports any **OpenAI-compatible API** via configurable environment variables:

**Supported Providers:**
- OpenAI (GPT-4, GPT-4o-mini, etc.)
- Ollama (local models like Llama, Mistral)
- LM Studio (local models)
- Azure OpenAI
- Any other OpenAI-compatible endpoint

**Configuration:**
Set in `.env`:
```
OPENAI_API_KEY=your-key
OPENAI_BASE_URL=https://api.openai.com/v1  # or custom endpoint
OPENAI_MODEL=gpt-4o-mini
```

**Operation Planning:**
1. **Function/Tool Calling** (preferred): Uses `propose_operations` tool schema
2. **JSON Mode Fallback**: For providers without tool calling support
3. **Heuristic Fallback**: Basic regex patterns when no LLM configured

Without API key:
- Falls back to basic heuristics (e.g., regex-based replace detection)
- Returns note to user about limited functionality

### Frontend State Management

The Vue app maintains:
- `fileId`: Current active document UUID
- `outline[]`: Live paragraph IDs/text/levels for anchor copy-paste
- `ops[]`: Planned operations JSON for preview before apply
- `versions[]`: List of version snapshots (v1, v2, ...)
- `baseId`/`revisedId`: Selected file IDs for redline comparison

## Key Implementation Details

### Inserting at Anchors (`doc_ops.py`)

Since `python-docx` doesn't support "insert at index", anchor-based insertions:
1. Find matching `paragraph_id` by recomputing IDs on current doc
2. Rebuild entire document with content inserted at correct position
3. This is a known limitation trade-off for stable IDs

### Redline Visual Diff (`doc_ops.py:redline_compare`)

- Uses `difflib.SequenceMatcher` for line-level diff of paragraph texts
- For "replace" opcodes, performs word-level diff within changed lines
- Generates new `.docx` with colored runs:
  - Deletions: red text + strikethrough
  - Insertions: green text + underline
- Not native Track Changes (future scope)

### Type Schema Sync

`Operation` and `OutlineItem` schemas must stay synchronized:
- Backend: `backend/models.py` (Pydantic)
- Frontend: `frontend/src/types.ts` (TypeScript)

## Project Planning Documents

- **PRD.md**: Product requirements, use cases, system design
- **PLANNING.md**: Milestones, delivery plan, QA strategy
- **TASKS.md**: Epics and task backlog with acceptance criteria

Refer to these for feature scope, acceptance criteria, and roadmap context.
